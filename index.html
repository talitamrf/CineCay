<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <link rel="icon" type="image/png" href="love-letter.png" />
    <title>CineCay</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      html,
      body {
        height: 100%;
        overflow-y: auto;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, sans-serif;
        text-align: center;
        background: linear-gradient(
          135deg,
          #ffc0cb 0%,
          #ffb6c1 50%,
          #fff0f6 100%
        );
        min-height: 100vh;
        min-height: -webkit-fill-available;
        padding: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .app-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(255, 182, 193, 0.4);
        max-width: 500px;
        width: 100%;
        border: 2px solid #ffb6c1;
        margin: 20px 0;
      }

      h1 {
        color: #e63946;
        margin-bottom: 15px;
        font-size: clamp(1.5rem, 5vw, 2rem);
        text-shadow: 2px 2px 4px rgba(255, 182, 193, 0.5);
      }

      .emoji {
        font-size: 1.1em;
      }

      p {
        color: #d62828;
        margin-bottom: 10px;
        font-weight: 500;
        font-size: clamp(0.9rem, 3vw, 1rem);
      }

      #nomes {
        width: 100%;
        padding: 12px;
        border-radius: 10px;
        border: 2px solid #ff6b9d;
        margin-bottom: 15px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.9);
        -webkit-appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
      }

      #nomes:focus {
        outline: none;
        border-color: #e63946;
        box-shadow: 0 0 0 3px rgba(255, 182, 193, 0.3);
      }

      .button-group {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      button {
        padding: 12px 20px;
        border: none;
        border-radius: 25px;
        background: linear-gradient(135deg, #ff6b9d, #e63946);
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: clamp(0.9rem, 3vw, 1rem);
        box-shadow: 0 4px 15px rgba(230, 57, 70, 0.3);
        touch-action: manipulation;
        flex: 1;
        min-width: 120px;
      }

      button:active {
        transform: scale(0.95);
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .roleta-wrapper {
        position: relative;
        width: min(90vw, 350px);
        height: min(90vw, 350px);
        margin: 0 auto;
      }

      .roleta-container {
        position: relative;
        width: 100%;
        height: 100%;
      }

      #roleta {
        width: 100%;
        height: 100%;
        display: block;
        filter: drop-shadow(0 5px 15px rgba(255, 107, 157, 0.3));
        border-radius: 50%;
        background: white;
        border: 6px solid #ff6b9d;
      }

      .seta-fixa {
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 20px solid transparent;
        border-right: 20px solid transparent;
        border-top: 35px solid #ffd700;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        z-index: 20;
      }

      .seta-fixa::after {
        content: url("star.png");
        position: absolute;
        top: -40px;
        left: -10px;
        font-size: 20px;
      }

      #resultado {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: clamp(1.2rem, 4vw, 1.8rem);
        font-weight: bold;
        color: white;
        background: linear-gradient(135deg, #ff6b9d 0%, #e63946 100%);
        padding: 20px 30px;
        border-radius: 20px;
        display: none;
        z-index: 1000;
        box-shadow: 0 10px 40px rgba(230, 57, 70, 0.4);
        animation: popIn 0.5s ease;
        border: 3px solid white;
        max-width: 90vw;
        text-align: center;
      }

      @keyframes popIn {
        0% {
          transform: translate(-50%, -50%) scale(0) rotate(-180deg);
          opacity: 0;
        }
        50% {
          transform: translate(-50%, -50%) scale(1.1) rotate(10deg);
        }
        100% {
          transform: translate(-50%, -50%) scale(1) rotate(0deg);
          opacity: 1;
        }
      }

      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 192, 203, 0.3);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        display: none;
        z-index: 999;
      }

      .historico {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px solid #ffb6c1;
      }

      .historico h3 {
        color: #e63946;
        margin-bottom: 10px;
        font-size: clamp(1rem, 3.5vw, 1.2rem);
      }

      #listaHistorico {
        list-style: none;
        max-height: 120px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      #listaHistorico li {
        padding: 8px 12px;
        margin: 5px 0;
        background: linear-gradient(
          135deg,
          rgba(255, 182, 193, 0.2),
          rgba(255, 107, 157, 0.2)
        );
        border-radius: 12px;
        color: #d62828;
        font-weight: 500;
        border: 1px solid rgba(255, 182, 193, 0.5);
        font-size: clamp(0.85rem, 3vw, 0.95rem);
      }

      #listaHistorico li:first-child {
        background: linear-gradient(
          135deg,
          rgba(255, 107, 157, 0.3),
          rgba(230, 57, 70, 0.3)
        );
        font-weight: bold;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
      }

      /* Botão de compartilhar/salvar */
      .share-section {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px solid #ffb6c1;
      }

      .share-btn {
        background: linear-gradient(135deg, #ff6b9d, #e63946);
        font-size: clamp(0.85rem, 3vw, 0.95rem);
      }

      /* Melhor suporte para iOS */
      @supports (-webkit-touch-callout: none) {
        body {
          min-height: -webkit-fill-available;
        }

        input,
        button {
          font-size: 16px !important;
        }
      }

      /* Animação de confete */
      .confete {
        position: fixed;
        width: 8px;
        height: 8px;
        background: #ff6b9d;
        animation: confete 3s linear;
        z-index: 1001;
        pointer-events: none;
      }

      @keyframes confete {
        0% {
          transform: translateY(-100vh) rotate(0deg);
          opacity: 1;
        }
        100% {
          transform: translateY(100vh) rotate(720deg);
          opacity: 0;
        }
      }

      /* Modo paisagem */
      @media (max-height: 500px) and (orientation: landscape) {
        .app-container {
          padding: 15px;
        }

        h1 {
          margin-bottom: 10px;
        }

        .roleta-wrapper {
          width: min(40vh, 250px);
          height: min(40vh, 250px);
        }

        #listaHistorico {
          max-height: 60px;
        }
      }

      .icone {
        width: 24px;
        height: 24px;
        vertical-align: middle;
      }
      .icone-grande {
        width: 32px;
        height: 32px;
        vertical-align: middle;
      }
    </style>
  </head>
  <body>
    <div class="overlay" onclick="fecharResultado()"></div>

    <div class="app-container">
      <h1>
        <span class="emoji"><img class="icone" src="strawberry.png" /></span>
        CineCay
        <span class="emoji"><img class="icone" src="cinema.png" /></span>
      </h1>
      <p>Roleta Excluiva!</p>
      <p>Digite os nomes separados por vírgula:</p>
      <input
        type="text"
        id="nomes"
        placeholder="Ex: Maria, João, Ana, Pedro"
        autocomplete="off"
      />

      <div class="button-group">
        <button onclick="iniciarRoleta()" id="btnGirar">
          <img src="dices.png" /> Sortear
        </button>
        <button onclick="limparTudo()"><img src="trash-2.png" /> Limpar</button>
      </div>

      <div class="roleta-wrapper">
        <div class="roleta-container">
          <div class="seta-fixa"></div>
          <canvas id="roleta"></canvas>
        </div>
      </div>

      <div class="historico">
        <h3><img src="clipboard-clock.png" /> Últimos Sorteados</h3>
        <ul id="listaHistorico"></ul>
      </div>

      <div class="share-section">
        <button onclick="salvarHistorico()" class="share-btn">
          <img src="save.png" />Salvar Sessão
        </button>
        <button onclick="carregarHistorico()" class="share-btn">
          <img src="folder-input.png" /> Carregar Sessão
        </button>
      </div>
    </div>

    <div id="resultado"></div>

    <script>
      let nomes = [];
      let girando = false;
      let historico = [];
      let anguloAtual = 0;
      const canvas = document.getElementById("roleta");
      const ctx = canvas.getContext("2d");
      const btnGirar = document.getElementById("btnGirar");

      // Cores: rosa, vermelho e branco alternados
      const cores = [
        "#ff6b9d",
        "#e63946",
        "#ffffff",
        "#ffb6c1",
        "#ff4757",
        "#fff0f6",
      ];

      document.addEventListener("gesturestart", (e) => e.preventDefault());
      document.addEventListener(
        "touchmove",
        (e) => {
          if (e.scale !== 1) {
            e.preventDefault(); 
          }
        },
        { passive: false }
      );

      // Ajusta o tamanho do canvas
      function ajustarCanvas() {
        const wrapper = document.querySelector(".roleta-wrapper");
        const size = wrapper.offsetWidth;
        canvas.width = size;
        canvas.height = size;
        desenharRoleta();
      }

      window.addEventListener("resize", ajustarCanvas);
      window.addEventListener("orientationchange", () => {
        setTimeout(ajustarCanvas, 100);
      });

      function desenharRoleta() {
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = Math.min(centerX, centerY) - 10;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (nomes.length === 0) {
          ctx.fillStyle = "#fff0f6";
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
          ctx.fill();

          ctx.fillStyle = "#ffb6c1";
          ctx.font = `bold ${canvas.width / 20}px Arial`;
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText("Adicione os nomes", centerX, centerY);
          return;
        }

        const anglePerItem = (2 * Math.PI) / nomes.length;

        nomes.forEach((nome, i) => {
          const startAngle = i * anglePerItem - Math.PI / 2 + anguloAtual;
          const endAngle = startAngle + anglePerItem;

          // Desenha setor
          ctx.fillStyle = cores[i % cores.length];
          ctx.beginPath();
          ctx.moveTo(centerX, centerY);
          ctx.arc(centerX, centerY, radius, startAngle, endAngle);
          ctx.closePath();
          ctx.fill();

          // Desenha borda
          ctx.strokeStyle = "#ff6b9d";
          ctx.lineWidth = 2;
          ctx.stroke();

          // Desenha texto
          ctx.save();
          ctx.translate(centerX, centerY);
          ctx.rotate(startAngle + anglePerItem / 2);
          ctx.textAlign = "right";

          if (
            cores[i % cores.length] === "#ffffff" ||
            cores[i % cores.length] === "#fff0f6"
          ) {
            ctx.fillStyle = "#e63946";
          } else {
            ctx.fillStyle = "#fff";
          }

          const fontSize = Math.max(12, Math.min(18, canvas.width / 25));
          ctx.font = `bold ${fontSize}px Arial`;
          ctx.shadowColor = "rgba(0,0,0,0.2)";
          ctx.shadowBlur = 2;
          ctx.fillText(nome, radius - 15, 0);
          ctx.restore();
        });

        // Círculo central
        ctx.fillStyle = "#fff";
        ctx.beginPath();
        ctx.arc(centerX, centerY, canvas.width / 15, 0, 2 * Math.PI);
        ctx.fill();
        ctx.strokeStyle = "#ff6b9d";
        ctx.lineWidth = 3;
        ctx.stroke();

        ctx.fillStyle = "#ff6b9d";
        ctx.font = `${canvas.width / 18}px Arial`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("♥", centerX, centerY);
      }

      function iniciarRoleta() {
        const entrada = document.getElementById("nomes").value;
        const nomesTemp = entrada
          .split(",")
          .map((n) => n.trim())
          .filter((n) => n);

        if (nomesTemp.length === 0) {
          alert("Por favor, digite pelo menos um nome!");
          return;
        }

        if (girando) return;

        nomes = nomesTemp;

        // Reseta o ângulo para cada nova rodada
        anguloAtual = 0;
        canvas.style.transform = "rotate(0deg)";
        canvas.style.transition = "none";

        setTimeout(() => {
          desenharRoleta();
          girar();
        }, 50);
      }

      function girar() {
        if (girando || nomes.length === 0) return;

        girando = true;
        btnGirar.disabled = true;

        // Sorteia de forma verdadeiramente aleatória
        const sorteioIndex = Math.floor(Math.random() * nomes.length);
        const anglePerItem = 360 / nomes.length;
        const anguloVencedor = sorteioIndex * anglePerItem;

        // Randomiza o número de voltas entre 4 e 7
        const voltas = 4 + Math.floor(Math.random() * 4);

        // Adiciona uma pequena variação aleatória para parecer mais natural
        const variacao = (Math.random() - 0.5) * (anglePerItem * 0.8);
        const anguloFinal =
          voltas * 360 + (360 - anguloVencedor - anglePerItem / 2) + variacao;

        // Atualiza o ângulo atual para a próxima rodada
        anguloAtual = (anguloFinal % 360) * (Math.PI / 180);

        canvas.style.transition =
          "transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)";
        canvas.style.transform = `rotate(${anguloFinal}deg)`;

        setTimeout(() => {
          mostrarResultado(nomes[sorteioIndex]);
          adicionarHistorico(nomes[sorteioIndex]);
          criarConfete();
          girando = false;
          btnGirar.disabled = false;
        }, 4000);
      }

      function mostrarResultado(vencedor) {
        const resultado = document.getElementById("resultado");
        const overlay = document.querySelector(".overlay");

        resultado.innerHTML = `${vencedor}  <img src="sparkle.png" alt="estrela" class="icone-estrela"><br><span style="font-size: 0.7em;">Foi sorteado(a)!</span>`;
        resultado.style.display = "block";
        overlay.style.display = "block";

        // Vibração no mobile (se suportado)
        if (navigator.vibrate) {
          navigator.vibrate([200, 100, 200]);
        }

        setTimeout(fecharResultado, 3000);
      }

      function fecharResultado() {
        document.getElementById("resultado").style.display = "none";
        document.querySelector(".overlay").style.display = "none";
      }

      function adicionarHistorico(nome) {
        const agora = new Date();
        const hora = agora.getHours().toString().padStart(2, "0");
        const minuto = agora.getMinutes().toString().padStart(2, "0");

        historico.unshift({
          nome: nome,
          horario: `${hora}:${minuto}`,
          timestamp: Date.now(),
        });

        if (historico.length > 10) historico.pop();

        atualizarListaHistorico();
        salvarLocal();
      }

      function atualizarListaHistorico() {
        const lista = document.getElementById("listaHistorico");
        lista.innerHTML = historico
          .slice(0, 5)
          .map(
            (item, i) =>
              `<li>${i === 0 ? '<img src="trophy.png">' : `${i + 1}º`} ${
                item.nome
              } - ${item.horario}</li>`
          )
          .join("");
      }

      function limparTudo() {
        document.getElementById("nomes").value = "";
        nomes = [];
        anguloAtual = 0;
        canvas.style.transform = "rotate(0deg)";
        canvas.style.transition = "none";
        setTimeout(() => {
          canvas.style.transition = "";
          desenharRoleta();
        }, 10);
      }

      function criarConfete() {
        const cores = ["#ff6b9d", "#e63946", "#ffb6c1", "#ffd700", "#ff4757"];
        const quantidade = window.innerWidth < 768 ? 20 : 30;

        for (let i = 0; i < quantidade; i++) {
          setTimeout(() => {
            const confete = document.createElement("div");
            confete.className = "confete";
            confete.style.left = Math.random() * 100 + "%";
            confete.style.background =
              cores[Math.floor(Math.random() * cores.length)];
            confete.style.transform = `rotate(${Math.random() * 360}deg)`;
            document.body.appendChild(confete);

            setTimeout(() => confete.remove(), 3000);
          }, i * 50);
        }
      }

      // Salvar e carregar histórico localmente
      function salvarLocal() {
        try {
          const dados = {
            historico: historico,
            timestamp: Date.now(),
          };
          localStorage.setItem("roletaHistorico", JSON.stringify(dados));
        } catch (e) {
          console.log("Não foi possível salvar no localStorage");
        }
      }

      function carregarLocal() {
        try {
          const dados = localStorage.getItem("roletaHistorico");
          if (dados) {
            const parsed = JSON.parse(dados);
            historico = parsed.historico || [];
            atualizarListaHistorico();
          }
        } catch (e) {
          console.log("Não foi possível carregar do localStorage");
        }
      }

      function salvarHistorico() {
        const dados = {
          historico: historico,
          data: new Date().toLocaleDateString("pt-BR"),
          hora: new Date().toLocaleTimeString("pt-BR"),
        };

        const texto = JSON.stringify(dados, null, 2);
        const blob = new Blob([texto], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `roleta_historico_${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);

        alert("Histórico salvo! Você pode compartilhar este arquivo.");
      }

      function carregarHistorico() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".json";
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const dados = JSON.parse(e.target.result);
                historico = dados.historico || [];
                atualizarListaHistorico();
                alert("Histórico carregado com sucesso!");
              } catch (err) {
                alert("Erro ao carregar o arquivo!");
              }
            };
            reader.readAsText(file);
          }
        };
        input.click();
      }

      // Inicialização
      setTimeout(ajustarCanvas, 100);
      carregarLocal();

      // Previne zoom no iOS ao focar no input
      document.addEventListener("gesturestart", (e) => e.preventDefault());
      document.addEventListener(
        "touchmove",
        (e) => {
          if (e.scale !== 1) e.preventDefault();
        },
        { passive: false }
      );
    </script>
  </body>
</html>
